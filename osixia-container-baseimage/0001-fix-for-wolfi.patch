From 4581bce1448a593d905f75dbb9e9898d7db83138 Mon Sep 17 00:00:00 2001
From: Dentrax <furkan.turkal@chainguard.dev>
Date: Fri, 31 May 2024 22:12:05 +0300
Subject: [PATCH] fix for wolfi

Signed-off-by: Dentrax <furkan.turkal@chainguard.dev>
---
 .../:ssl-tools/assets/tool/ssl-helper          | 18 +++++++++---------
 image/tool/add-service-available               |  3 +++
 image/tool/install-service                     |  4 ++++
 image/tool/run                                 |  4 ++--
 4 files changed, 18 insertions(+), 11 deletions(-)

diff --git a/image/service-available/:ssl-tools/assets/tool/ssl-helper b/image/service-available/:ssl-tools/assets/tool/ssl-helper
index 8a5d717..4c64d8f 100755
--- a/image/service-available/:ssl-tools/assets/tool/ssl-helper
+++ b/image/service-available/:ssl-tools/assets/tool/ssl-helper
@@ -23,19 +23,19 @@ PREFIX_SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE=${PREFIX}_SSL_HELPER_AUTO_RENEW_CERT
 PREFIX_SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE=${PREFIX}_SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE
 PREFIX_SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE=${PREFIX}_SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE
 
-SSL_HELPER_TOOL=${!PREFIX_SSL_HELPER_TOOL:-$SSL_HELPER_TOOL}
-SSL_HELPER_AUTO_RENEW=${!PREFIX_SSL_HELPER_AUTO_RENEW:-$SSL_HELPER_AUTO_RENEW}
-SSL_HELPER_AUTO_RENEW_CRON_EXP=${!PREFIX_SSL_HELPER_AUTO_RENEW_CRON_EXP:-$SSL_HELPER_AUTO_RENEW_CRON_EXP}
-SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED=${!PREFIX_SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED:-$SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED}
-SSL_HELPER_AUTO_RENEW_FROM_FILES=${!PREFIX_SSL_HELPER_AUTO_RENEW_FROM_FILES:-$SSL_HELPER_AUTO_RENEW_FROM_FILES}
-SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE=${!PREFIX_SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE:-$SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE}
-SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE=${!PREFIX_SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE:-$SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE}
-SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE=${!PREFIX_SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE:-$SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE}
+SSL_HELPER_TOOL=${PREFIX_SSL_HELPER_TOOL:-$SSL_HELPER_TOOL}
+SSL_HELPER_AUTO_RENEW=${PREFIX_SSL_HELPER_AUTO_RENEW:-$SSL_HELPER_AUTO_RENEW}
+SSL_HELPER_AUTO_RENEW_CRON_EXP=${PREFIX_SSL_HELPER_AUTO_RENEW_CRON_EXP:-$SSL_HELPER_AUTO_RENEW_CRON_EXP}
+SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED=${PREFIX_SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED:-$SSL_HELPER_AUTO_RENEW_SERVICES_IMPACTED}
+SSL_HELPER_AUTO_RENEW_FROM_FILES=${PREFIX_SSL_HELPER_AUTO_RENEW_FROM_FILES:-$SSL_HELPER_AUTO_RENEW_FROM_FILES}
+SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE=${PREFIX_SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE:-$SSL_HELPER_AUTO_RENEW_CERT_FROM_FILE}
+SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE=${PREFIX_SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE:-$SSL_HELPER_AUTO_RENEW_KEY_FROM_FILE}
+SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE=${PREFIX_SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE:-$SSL_HELPER_AUTO_RENEW_CA_CERT_FROM_FILE}
 
 source "${CONTAINER_SERVICE_DIR}/:ssl-tools/assets/default-env"
 
 # call the certificate tool cfssl-helper (default) or jsonssl-helper
-${SSL_HELPER_TOOL,,} "${PREFIX}" "${CERT_FILE}" "${KEY_FILE}" "${CA_FILE}"
+cfssl-helper "${PREFIX}" "${CERT_FILE}" "${KEY_FILE}" "${CA_FILE}"
 
 # auto-renew certificates just before it expired
 # or if source files have changed
diff --git a/image/tool/add-service-available b/image/tool/add-service-available
index 081f7c3..04a34ff 100755
--- a/image/tool/add-service-available
+++ b/image/tool/add-service-available
@@ -7,6 +7,9 @@ SERVICE_DIR="/container/service"
 SERVICE_AVAILABLE_DIR="/container/service-available"
 DOWNLOAD_FILENAME="download.sh"
 
+echo "(Chainguard) All the necessary services already bundled in the image runtime. No need any further action."
+exit 0
+
 for i in "$@"
 do
     
diff --git a/image/tool/install-service b/image/tool/install-service
index b8a5782..06d2185 100755
--- a/image/tool/install-service
+++ b/image/tool/install-service
@@ -7,6 +7,10 @@ PROCESS_FILENAME = "process.sh"
 nb_process = 0
 
 print("install-service")
+
+print("(Chainguard) All the necessary services already installed in the image runtime. No need any further action.")
+os._exit(0)
+
 # Auto run global install script if available
 if os.path.isfile(SERVICE_DIR + os.sep + INSTALL_FILENAME):
     print(("run " + SERVICE_DIR + os.sep + INSTALL_FILENAME))
diff --git a/image/tool/run b/image/tool/run
index 1f04a55..5057b1f 100755
--- a/image/tool/run
+++ b/image/tool/run
@@ -14,7 +14,7 @@ LOG_LEVEL_INFO  = 3
 LOG_LEVEL_DEBUG = 4
 LOG_LEVEL_TRACE = 5
 
-SHENV_NAME_WHITELIST_REGEX = re.compile('\W')
+SHENV_NAME_WHITELIST_REGEX = re.compile(r'\W')
 
 log_level = None
 
@@ -200,7 +200,7 @@ def generic_import_envvars(path, override_existing_environment):
 				# Text files often end with a trailing newline, which we
 				# don't want to include in the env variable value. See
 				# https://github.com/phusion/baseimage-docker/pull/49
-				value = re.sub('\n\Z', '', f.read())
+				value = re.sub(r'\n\Z', '', f.read())
 			new_env[name] = value
 			trace("import " + name + " from " + filePath)
 
-- 
2.39.3 (Apple Git-146)

