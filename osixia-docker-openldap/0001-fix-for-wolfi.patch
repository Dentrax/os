From c86f7249d562a554b18f297f93854c4152b4b3af Mon Sep 17 00:00:00 2001
From: Dentrax <furkan.turkal@chainguard.dev>
Date: Fri, 24 May 2024 11:57:25 +0300
Subject: [PATCH] fix for wolfi

Signed-off-by: Dentrax <furkan.turkal@chainguard.dev>
---
 image/service/slapd/process.sh |  2 +-
 image/service/slapd/startup.sh | 50 +++++++++++++++++++---------------
 2 files changed, 29 insertions(+), 23 deletions(-)

diff --git a/image/service/slapd/process.sh b/image/service/slapd/process.sh
index a669300..7df7839 100755
--- a/image/service/slapd/process.sh
+++ b/image/service/slapd/process.sh
@@ -11,6 +11,6 @@ ulimit -n $LDAP_NOFILE
 
 # Call hostname to determine the fully qualified domain name. We want OpenLDAP to listen
 # to the named host for the ldap:// and ldaps:// protocols.
-FQDN="$(/bin/hostname --fqdn)"
+FQDN="$(/bin/hostname -f)"
 HOST_PARAM="ldap://$FQDN:$LDAP_PORT ldaps://$FQDN:$LDAPS_PORT"
 exec /usr/sbin/slapd -h "$HOST_PARAM ldapi:///" -u openldap -g openldap -d "$LDAP_LOG_LEVEL"
diff --git a/image/service/slapd/startup.sh b/image/service/slapd/startup.sh
index dae1bd2..04ef566 100755
--- a/image/service/slapd/startup.sh
+++ b/image/service/slapd/startup.sh
@@ -53,12 +53,14 @@ CUR_USER_UID=`id -u openldap || true`
 LDAP_UIDGID_CHANGED=false
 if [ "$LDAP_OPENLDAP_UID" != "$CUR_USER_UID" ]; then
     log-helper info "CUR_USER_UID (${CUR_USER_UID}) does't match LDAP_OPENLDAP_UID (${LDAP_OPENLDAP_UID}), adjusting..."
-    usermod -o -u "$LDAP_OPENLDAP_UID" openldap
+    # Even though we will set the UID in the Apko manifest, we had to replace the usermod command since it is not available in the Wolfi.
+    adduser -u "$LDAP_OPENLDAP_UID" -D openldap
     LDAP_UIDGID_CHANGED=true
 fi
 if [ "$LDAP_OPENLDAP_GID" != "$CUR_USER_GID" ]; then
     log-helper info "CUR_USER_GID (${CUR_USER_GID}) does't match LDAP_OPENLDAP_GID (${LDAP_OPENLDAP_GID}), adjusting..."
-    groupmod -o -g "$LDAP_OPENLDAP_GID" openldap
+    # Even though we will set the GID in the Apko manifest, we had to replace the groupmod commands since it is not available in the Wolfi.
+    addgroup -g "$LDAP_OPENLDAP_GID" openldap
     LDAP_UIDGID_CHANGED=true
 fi
 
@@ -187,26 +189,29 @@ if [ ! -e "$FIRST_START_DONE" ]; then
     log-helper info "Init new ldap server..."
 
     get_ldap_base_dn
-    cat <<EOF | debconf-set-selections
-slapd slapd/internal/generated_adminpw password ${LDAP_ADMIN_PASSWORD}
-slapd slapd/internal/adminpw password ${LDAP_ADMIN_PASSWORD}
-slapd slapd/password2 password ${LDAP_ADMIN_PASSWORD}
-slapd slapd/password1 password ${LDAP_ADMIN_PASSWORD}
-slapd slapd/dump_database_destdir string /var/backups/slapd-VERSION
-slapd slapd/domain string ${LDAP_DOMAIN}
-slapd shared/organization string ${LDAP_ORGANISATION}
-slapd slapd/backend string ${LDAP_BACKEND^^}
-slapd slapd/purge_database boolean true
-slapd slapd/move_old_database boolean true
-slapd slapd/allow_ldap_v2 boolean false
-slapd slapd/no_configuration boolean false
-slapd slapd/dump_database select when needed
-EOF
-
-    dpkg-reconfigure -f noninteractive slapd
+# Skip the Debian package scripts, we will go with whatever is closes to the openldap source, or what the alpine package ships with.
+#     cat <<EOF | debconf-set-selections
+# slapd slapd/internal/generated_adminpw password ${LDAP_ADMIN_PASSWORD}
+# slapd slapd/internal/adminpw password ${LDAP_ADMIN_PASSWORD}
+# slapd slapd/password2 password ${LDAP_ADMIN_PASSWORD}
+# slapd slapd/password1 password ${LDAP_ADMIN_PASSWORD}
+# slapd slapd/dump_database_destdir string /var/backups/slapd-VERSION
+# slapd slapd/domain string ${LDAP_DOMAIN}
+# slapd shared/organization string ${LDAP_ORGANISATION}
+# slapd slapd/backend string ${LDAP_BACKEND^^}
+# slapd slapd/purge_database boolean true
+# slapd slapd/move_old_database boolean true
+# slapd slapd/allow_ldap_v2 boolean false
+# slapd slapd/no_configuration boolean false
+# slapd slapd/dump_database select when needed
+# EOF
+
+#     dpkg-reconfigure -f noninteractive slapd
 
     # RFC2307bis schema
     if [ "${LDAP_RFC2307BIS_SCHEMA,,}" == "true" ]; then
+      log-helper error "(Chainguard) Error: LDAP_RFC2307BIS_SCHEMA=true is not supported in this image. Please reach us for support."
+      exit 1
 
       log-helper info "Switching schema to RFC2307bis..."
       cp ${CONTAINER_SERVICE_DIR}/slapd/assets/config/bootstrap/schema/rfc2307bis.* /etc/ldap/schema/
@@ -223,7 +228,8 @@ EOF
       fi
     fi
 
-    rm ${CONTAINER_SERVICE_DIR}/slapd/assets/config/bootstrap/schema/rfc2307bis.*
+    # We don't copy the schema files
+    # rm ${CONTAINER_SERVICE_DIR}/slapd/assets/config/bootstrap/schema/rfc2307bis.*
 
   #
   # Error: the database directory (/var/lib/ldap) is empty but not the config directory (/etc/ldap/slapd.d)
@@ -567,8 +573,8 @@ ln -sf ${CONTAINER_SERVICE_DIR}/slapd/assets/ldap.conf /etc/ldap/ldap.conf
 # force OpenLDAP to listen on all interfaces
 # We need to make sure that /etc/hosts continues to include the
 # fully-qualified domain name and not just the specified hostname.
-# Without the FQDN, /bin/hostname --fqdn stops working.
-FQDN="$(/bin/hostname --fqdn)"
+# Without the FQDN, /bin/hostname -f stops working.
+FQDN="$(/bin/hostname -f)"
 if [ "$FQDN" != "$HOSTNAME" ]; then
     FQDN_PARAM="$FQDN"
 else
-- 
2.39.3 (Apple Git-146)

